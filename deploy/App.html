<!DOCTYPE html>
<html>
<head>
    <title>Release Plan</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext,__map=function(mapField,records){var map={};return Ext.Array.each(records,function(record){record.raw?map[record.raw[mapField]]=record.raw:map[record[mapField]]=record}),map},__sortByDate=function(dateField,outField,map){var arr=Ext.Object.getValues(map),sorted=[];return arr.sort(function(a,b){var da=Rally.util.DateTime.fromIsoString(a[dateField]),db=Rally.util.DateTime.fromIsoString(b[dateField]);return Rally.util.DateTime.getDifference(da,db,"day")}),Ext.Array.each(arr,function(rec){sorted.push(rec[outField])}),sorted},__sumArray=function(arr,selectorFn){var count=0;return Ext.Array.each(arr,function(item){var num=parseInt(selectorFn(item)+"",10);isNaN(num)||(count+=num)}),count};Ext.define("ReleasePlanCalculator",{extend:"Rally.data.lookback.calculator.BaseCalculator",_mapReleasesByName:Ext.bind(__map,this,["Name"],0),_sortReleasesByStartDate:Ext.bind(__sortByDate,this,["ReleaseStartDate","Name"],0),_mapIterationsByName:Ext.bind(__map,this,["Name"],0),_sortIterationsByStartDate:Ext.bind(__sortByDate,this,["StartDate","Name"],0),_sumArrayByPlanEstimate:Ext.bind(__sumArray,this,[function(item){return item.PlanEstimate||"0"}],1),_sumArrayByPreliminaryEstimate:Ext.bind(__sumArray,this,[function(item){return item.raw&&(item=item.raw),item.PreliminaryEstimate?item.PreliminaryEstimate.Value||"0":"0"}],1),prepareChartData:function(stores){var snapshots=[];return Ext.Array.each(stores,function(store){store.each(function(record){snapshots.push(record.raw)})}),this.runCalculation(snapshots)},_bucketArtifactsIntoIterations:function(records){var me=this,rawData={};return Ext.Array.each(records,function(record){if(-1===record._type.toLowerCase().indexOf("portfolio")&&-1===record._type.toLowerCase().indexOf("iteration")&&record.Iteration){var key=me._getBucketKey(record);rawData[key]=me._pushRecord(rawData[key],record)}}),rawData},_bucketAcceptedArtifactsIntoIterations:function(records){var me=this,acceptedRawData={};return Ext.Array.each(records,function(record){if(-1===record._type.toLowerCase().indexOf("portfolio")&&-1===record._type.toLowerCase().indexOf("iteration")&&record.Iteration){var key=me._getBucketKey(record);record.AcceptedDate&&(acceptedRawData[key]=me._pushRecord(acceptedRawData[key],record))}}),acceptedRawData},_bucketFeaturesIntoReleases:function(records){var bucket={};return Ext.Array.each(records,function(record){-1!==record._type.toLowerCase().indexOf("portfolioitem")&&record.Release&&(bucket[record.Release.Name]=bucket[record.Release.Name]||[],bucket[record.Release.Name].push(record))}),bucket},_bucketStoriesIntoReleases:function(records){var bucket={};return Ext.Array.each(records,function(record){-1===record._type.toLowerCase().indexOf("portfolioitem")&&-1===record._type.toLowerCase().indexOf("iteration")&&record.Release&&(bucket[record.Release.Name]=bucket[record.Release.Name]||[],bucket[record.Release.Name].push(record))}),bucket},_computeNumberOfIterations:function(releases){for(var startRelease=releases[0],endRelease=releases[releases.length-1],count=0,max=100,currentDate=Rally.util.DateTime.fromIsoString(startRelease.raw.ReleaseStartDate),endDate=Rally.util.DateTime.fromIsoString(endRelease.raw.ReleaseDate);0>Rally.util.DateTime.getDifference(currentDate,endDate,"day");)count++,currentDate=Rally.util.DateTime.add(currentDate,"day",14);return console.log("Number of future iterations",count),count},_shimFutureIterations:function(iterationOrder,iterationMap,totalIterations,earliestStartDate){var me=this,lastIteration=iterationMap[iterationOrder[iterationOrder.length-1]],currentSDate,currentEDate,numToCreate=totalIterations-iterationOrder.length,iteration={Name:"",EndDate:""},iterations=[],i;for(lastIteration?(currentSDate=Rally.util.DateTime.fromIsoString(lastIteration.StartDate),currentEDate=Rally.util.DateTime.fromIsoString(lastIteration.EndDate)):(currentSDate=Rally.util.DataTime.fromIsoString(earliestStartDate),currentEDate=Rally.util.DateTime.add(currentSDate,13,"day")),i=0;numToCreate>i;i++)currentSDate=Rally.util.DateTime.add(currentSDate,"day",14),currentEDate=Rally.util.DateTime.add(currentEDate,"day",14),iteration.Name="Future Iteration "+(i+1),iteration.StartDate=Rally.util.DateTime.toIsoString(currentSDate),iteration.EndDate=Rally.util.DateTime.toIsoString(currentEDate),iterations.push(iteration.Name),iterationMap[iteration.Name]=iteration;return iterations},_isIterationInRelease:function(iteration,release){var iStart=Rally.util.DateTime.fromIsoString(iteration.StartDate),rStart=Rally.util.DateTime.fromIsoString(release.ReleaseStartDate),rEnd=Rally.util.DateTime.fromIsoString(release.ReleaseDate);return!!(Rally.util.DateTime.getDifference(iStart,rStart,"day")>=0&&Rally.util.DateTime.getDifference(rEnd,iStart,"day")>=1)},_getReleaseFromIteration:function(iteration,releases){var me=this,ret=null;return Ext.Array.each(releases,function(release){ret||me._isIterationInRelease(iteration,release.raw)&&(ret=release)}),ret},_getIterations:function(records){var iterations=[];return Ext.Array.each(records,function(record){"iteration"===record._type.toLowerCase()&&iterations.push(record)}),iterations},_getBucketKey:function(record){return this._getIterationKey(record.Iteration)},_getIterationKey:function(iteration){var rawDate=Rally.util.DateTime.fromIsoString(iteration.EndDate),timezone=Rally.util.DateTime.parseTimezoneOffset(iteration.EndDate),localDate=Rally.util.DateTime.add(rawDate,"minute",-1*timezone),date=Rally.util.DateTime.formatWithDefault(localDate);return iteration.Name+"<br>"+date},_pushRecord:function(arr,itm){return Ext.isArray(arr)?arr.concat([itm]):[itm]},runCalculation:function(records){var me=this,now=new Date,releaseMap=me._mapReleasesByName(me.releases),releaseOrder=me._sortReleasesByStartDate(releaseMap);me.iterations=me._getIterations(records);var iterationMap=me._mapIterationsByName(me.iterations),iterationOrder=me._sortIterationsByStartDate(iterationMap),rawData=me._bucketArtifactsIntoIterations(records),acceptedRawData=me._bucketAcceptedArtifactsIntoIterations(records),iterationData={};me.releases.sort(function(a,b){var da=Rally.util.DateTime.fromIsoString(a.raw.ReleaseStartDate),db=Rally.util.DateTime.fromIsoString(b.raw.ReleaseStartDate);return Rally.util.DateTime.getDifference(da,db,"day")});var countOfIterations=me._computeNumberOfIterations(me.releases),startDate=me.releases[0].raw.ReleaseStartDate,iterationShim=me._shimFutureIterations(iterationOrder,iterationMap,countOfIterations,startDate),allIterations=iterationOrder.concat(iterationShim),releaseData=me._bucketFeaturesIntoReleases(records),releaseStoryData=me._bucketStoriesIntoReleases(records),categories,series=[],totalCount=0,toplineCount=0,toplineData={},topline=[],piToplineCount=0,piToplineData={},piTopline=[],scheduledCount=0,scheduledData={},scheduledPrevRel="",scheduledPrevAmount=0,scheduledReleaseData={},scheduled=[],actualBurnup=[],plannedBurnup=[],velocity=parseInt(me.velocity+"",10),i,ii,prev;return scheduledCount=0,scheduledPrevAmount=0,Ext.Array.each(iterationOrder,function(iteration){var rel=me._getReleaseFromIteration(iterationMap[iteration],me.releases),amount=parseInt(""+me._sumArrayByPlanEstimate(rawData[me._getIterationKey(iterationMap[iteration])]));scheduledData[rel.raw.Name]=scheduledData[rel.raw.Name]||0,rel.raw.Name!==scheduledPrevRel&&(scheduledCount=scheduledPrevAmount,scheduledPrevRel=rel.raw.Name),amount&&!isNaN(amount)&&(scheduledData[rel.raw.Name]=scheduledData[rel.raw.Name]+amount+scheduledCount,scheduledPrevAmount=scheduledData[rel.raw.Name]),scheduledCount=0}),totalCount=0,Ext.Array.each(releaseOrder,function(release){var amount=me._sumArrayByPreliminaryEstimate(releaseData[release]);amount&&(totalCount+=amount),piToplineData[release]=totalCount}),totalCount=0,Ext.Array.each(releaseOrder,function(release){var amount=me._sumArrayByPlanEstimate(releaseStoryData[release]);amount&&(totalCount+=amount),toplineData[release]=totalCount}),Ext.Object.each(rawData,function(key,data){iterationData[key]=0}),totalCount=0,prev=0,Ext.Array.each(allIterations,function(iterationName){var key=me._getIterationKey(iterationMap[iterationName]),amount=me._sumArrayByPlanEstimate(acceptedRawData[key]),piRelease=me._getReleaseFromIteration(iterationMap[iterationName],me.releases),iStart=Rally.util.DateTime.fromIsoString(iterationMap[iterationName].StartDate),iEnd=Rally.util.DateTime.fromIsoString(iterationMap[iterationName].EndDate),currentIteration;plannedBurnup.push(prev+velocity),piRelease?(piTopline.push(piToplineData[piRelease.raw.Name]||0),topline.push(toplineData[piRelease.raw.Name]||0),scheduled.push(scheduledData[piRelease.raw.Name]||0)):(piTopline.push(piTopline[piTopline.length-1]),topline.push(topline[topline.length-1]),scheduled.push(scheduled[scheduled.length-1])),currentIteration=Rally.util.DateTime.getDifference(iEnd,now,"day")>0,currentIteration=currentIteration&&Rally.util.DateTime.getDifference(now,iStart,"day")>0,amount?(totalCount=amount+totalCount,actualBurnup.push(totalCount),currentIteration?prev+=velocity:prev=totalCount):(actualBurnup.push(0),prev+=velocity)}),series.push({type:"column",name:"Actuals",data:actualBurnup}),series.push({type:"column",name:"Planned ("+velocity+")",data:plannedBurnup}),series.push({type:"line",name:"Scheduled Story Points",visible:!1,data:scheduled}),series.push({type:"line",name:"Release Topline",data:topline}),series.push({type:"line",name:"Feature Point Topline",visible:!1,data:piTopline}),categories=[],Ext.Array.each(iterationOrder,function(iName){categories.push(me._getIterationKey(iterationMap[iName]))}),{categories:categories.concat(iterationShim),series:series}}});
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",settingsScope:"project",config:{defaultSettings:{includeBefore:0,includeAfter:0,includePartialSprints:!1,teamVelocity:50}},getSettingsFields:function(){return[{name:"includeBefore",label:"Include Previous Releases",xtype:"rallynumberfield"},{name:"includeAfter",label:"Include Subsequent Releases",xtype:"rallynumberfield"},{name:"teamVelocity",label:"Velocity",xtype:"rallynumberfield"},{name:"includePartialSprints",label:"Include Partial Sprints",xtype:"rallycheckboxfield"}]},addContent:function(scope){console.log("addContent");var me=this;Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,remoteFilter:!1,model:"TypeDefinition",sorters:[{property:"Ordinal",direction:"Desc"}],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],listeners:{load:function(store,recs){me.piTypes={},Ext.Array.each(recs,function(type){me.piTypes[type.get("Ordinal")+""]=type.get("TypePath")}),me.onScopeChange(scope)},scope:me}})},onScopeChange:function(scope){console.log(this.piTypes),_.isUndefined(this.piTypes)?this.addContent(scope):this.run(scope)},run:function(scope){var me=this,query,requestedReleases=[],processedReleases=[],numReleaseReqs=0,preRels=parseInt(""+me.getSetting("includeBefore"),10)||0,supRels=parseInt(""+me.getSetting("includeAfter"),10)||0,doProcess=function(records,operator,success){var rels=[];records&&processedReleases.push(records),processedReleases.length===numReleaseReqs&&(rels=rels.concat.apply(rels,processedReleases),rels.push(scope.getRecord()),rels.sort(function(a,b){var da=Rally.util.DateTime.fromIsoString(a.raw.ReleaseStartDate),db=Rally.util.DateTime.fromIsoString(b.raw.ReleaseStartDate);return Rally.util.DateTime.getDifference(da,db,"day")}),me._createChart(rels))};preRels&&(numReleaseReqs++,requestedReleases.push(Ext.create("Rally.data.WsapiDataStore",{model:"Release",pageSize:preRels,remoteFilter:!0,remoteSort:!0,context:{projectScopeUp:!1,projectScopeDown:!1},sorters:[{property:"ReleaseStartDate",direction:"DESC"}],filters:[{property:"ReleaseStartDate",operator:"<",value:me._getStartDate(scope.getRecord())}]}))),supRels&&(numReleaseReqs++,requestedReleases.push(Ext.create("Rally.data.WsapiDataStore",{model:"Release",pageSize:supRels,remoteFilter:!0,remoteSort:!0,context:{projectScopeUp:!1,projectScopeDown:!1},sorters:[{property:"ReleaseStartDate",direction:"ASC"}],filters:[{property:"ReleaseDate",operator:">",value:me._getEndDate(scope.getRecord())}]}))),Ext.Array.each(requestedReleases,function(rr){rr.loadPage(1,{scope:me,callback:doProcess})}),preRels||supRels||doProcess()},_buildQuery:function(releases){var me=this,query,scope=me.getContext().getTimeboxScope(),includePartialIterations=!!me.getSetting("includePartialSprints"),beginProperty=includePartialIterations?"Iteration.EndDate":"Iteration.StartDate",beginOp=includePartialIterations?">":">=",endProperty=includePartialIterations?"Iteration.StartDate":"Iteration.EndDate",endOp=includePartialIterations?"<":"<=",startDate=me._getStartDate(releases[0]),endDate=me._getEndDate(releases[releases.length-1]);return query=Rally.data.QueryFilter.and([{property:beginProperty,operator:beginOp,value:startDate},{property:endProperty,operator:endOp,value:endDate}]),query=query.or(Rally.data.QueryFilter.and([{property:"Release.ReleaseStartDate",operator:">=",value:startDate},{property:"Release.ReleaseDate",operator:"<=",value:endDate}]))},_buildIterationQuery:function(releases){var me=this,query,scope=me.getContext().getTimeboxScope(),includePartialIterations=!!me.getSetting("includePartialSprints"),beginProperty=includePartialIterations?"EndDate":"StartDate",beginOp=includePartialIterations?">":">=",endProperty=includePartialIterations?"StartDate":"EndDate",endOp=includePartialIterations?"<":"<=";return query=Rally.data.QueryFilter.and([{property:beginProperty,operator:beginOp,value:me._getStartDate(releases[0])},{property:endProperty,operator:endOp,value:me._getEndDate(releases[releases.length-1])}])},_createChart:function(releases){var me=this,chart,scope=me.getContext().getTimeboxScope(),query=me._buildQuery(releases),iq=me._buildIterationQuery(releases);me.removeAll(!0);var subtitle=Ext.Array.map(releases,function(release){return release.get("Name")}).join(", ");chart=Ext.create("Rally.ui.chart.Chart",{storeType:"Rally.data.WsapiDataStore",storeConfig:me._getStoreConfig(query,iq),calculatorType:"ReleasePlanCalculator",calculatorConfig:{releases:releases,velocity:me.getSetting("teamVelocity")},chartConfig:{chart:{type:"column",height:me.getHeight(),width:me.getWidth()},exporting:{sourceHeight:me.getHeight(),sourceWidth:me.getWidth()},title:{text:"Release Plan"},subtitle:{text:subtitle},xAxis:{title:{text:"Iterations"}},yAxis:{min:0,title:{text:"Story Points"}}}}),me.add(chart)},_getStartDate:function(release){return release.raw.ReleaseStartDate},_getEndDate:function(release){return release.raw.ReleaseDate},_getStoreConfig:function(query,iq){var me=this,stores=[];return Ext.Array.each(["HierarchicalRequirement","Defect","DefectSuite"],function(type){stores.push({model:type,filters:query,fetch:["Name","Iteration","StartDate","EndDate","Release","ReleaseStartDate","ReleaseDate","PlanEstimate","ScheduleState","AcceptedDate"]})}),stores.push({model:me.piTypes["0"],filters:me.getContext().getTimeboxScope().getQueryFilter(),fetch:["Name","Release","ReleaseStartDate","ReleaseDate","PreliminaryEstimate","Value","UserStories","PlanEstimate"]}),stores.push({model:"Iteration",filters:iq,fetch:["Name","StartDate","EndDate"]}),stores}});

            Rally.launchApp('CustomApp', {
                name:"Release Plan",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
