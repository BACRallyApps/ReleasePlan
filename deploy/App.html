<!DOCTYPE html>
<html>
<head>
    <title>Release Plan</title>

    <script type="text/javascript" src="//rally1.rallydev.com/apps/2.0rc1/sdk.js?wsapiVersion=1.43"></script>
    <script type="text/javascript" src="//rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>



    <script type="text/javascript">
        Rally.onReady(function () {
var Ext = window.Ext4 || window.Ext;

Ext.define('ReleasePlanCalculator', {
    extend: 'Rally.data.lookback.calculator.BaseCalculator',

    prepareChartData: function (stores) {
      var snapshots = [];

      Ext.Array.each(stores, function (store) {
        store.each(function (record) {
          snapshots.push(record.raw);
        });
      });

      return this.runCalculation(snapshots);
    },

    runCalculation: function (records) {
      console.log('Running Calculations');
      console.dir(records);

      var me = this;
      var rawData = {};
      var acceptedRawData = {};
      var iterationData = {};
      var categories;
      var series = [];
      var totalCount = 0;
      var toplineCount = 0;
      var piToplineCount = 0;
      var piTopline = [];
      var plannedBurnup = [];
      var topline = [];
      var velocity = parseInt(me.velocity + '', 10);
      var i, ii;

      Ext.Array.each(records, function (record) {
        if (record._type.toLowerCase().indexOf('portfolio') !== -1) {
          return;
        }

        var key = me._getBucketKey(record);
        rawData[key] = me._pushRecord(rawData[key], record);

        if (record.AcceptedDate) {
          acceptedRawData[key] = me._pushRecord(acceptedRawData[key], record);
        }
      });

      Ext.Object.each(rawData, function (key, data) {
        iterationData[key] = 0;
      });

      Ext.Object.each(acceptedRawData, function (key, data) {
        totalCount = me._sumArray(data) + totalCount;
        iterationData[key] = totalCount;
      });

      series.push({
        type: 'column',
        name: 'Actuals',
        data: Ext.Object.getValues(iterationData)
      });

      for (i = 1, ii = Ext.Object.getKeys(iterationData).length; i <= ii; i++) {
        plannedBurnup.push(i * velocity);
      }

      series.push({
        type: 'column',
        name: 'Planned (' + velocity + ')',
        data: plannedBurnup
      });

      Ext.Object.each(rawData, function (key, data) {
        toplineCount = me._sumArray(data) + toplineCount;
      });

      for (i = 1, ii = Ext.Object.getKeys(iterationData).length; i <= ii; i++) {
        topline.push(toplineCount);
      }

      series.push({
        type: 'line',
        name: 'Story Point Topline',
        data: topline
      });

      Ext.Array.each(records, function (record) {
        var value = NaN;
        if (record._type.toLowerCase().indexOf('portfolio') === -1) {
          return;
        }

        if (record.PreliminaryEstimate) {
          value = parseInt(record.PreliminaryEstimate.Value + '', 10);
        }

        console.log('Value for PI', record, value);

        if (!isNaN(value)) {
          piToplineCount = piToplineCount + value;
        }
      });

      for (i = 1, ii = Ext.Object.getKeys(iterationData).length; i <= ii; i++) {
        piTopline.push(piToplineCount);
      }

      series.push({
        type: 'line',
        name: 'Feature Point Topline',
        data: piTopline
      });

      return {
        categories: Ext.Object.getKeys(iterationData),
        series: series
      };
    },

    _getBucketKey: function (record) {
      var date = Rally.util.DateTime.format(Rally.util.DateTime.fromIsoString(record.Iteration.EndDate), 'm/d/Y');
      return record.Iteration.Name + '<br>' + date;
    },

    _pushRecord: function (arr, itm) {
      if (!Ext.isArray(arr)) {
        return [itm];
      } else {
        return arr.concat([itm]);
      }
    },

    _sumArray: function (arr) {
      var count = 0;

      Ext.Array.each(arr, function (item) {
        var num = parseInt(item.PlanEstimate + '', 10);

        if (!isNaN(num)) {
          count = count + num;
        }
      });

      return count;
    }
});

var Ext = window.Ext4 || window.Ext;

Ext.define('CustomApp', {
    extend: 'Rally.app.TimeboxScopedApp',
    componentCls: 'app',

    scopeType: 'release',

    settingsScope: 'project',
    config: {
      defaultSettings: {
        includeBefore: 0,
        includeAfter: 0,
        includePartialSprints: false,
        teamVelocity: 50
      }
    },

    getSettingsFields: function () {
      return [{
        name: 'teamVelocity',
        label: 'Velocity',
        xtype: 'rallynumberfield'
      }, {
        name: 'includePartialSprints',
        label: 'Include Partial Sprints',
        xtype: 'rallycheckboxfield'
      }];
    },

    addContent: function (scope) {
      var me = this;

      Ext.create('Rally.data.WsapiDataStore', {
        autoLoad: true,
        remoteFilter: false,
        model: 'TypeDefinition',
        sorters: [{
          property: 'Ordinal',
          direction: 'Desc'
        }],
        filters: [{
          property: 'Parent.Name',
          operator: '=',
          value: 'Portfolio Item'
        }, {
          property: 'Creatable',
          operator: '=',
          value: 'true'
        }],
        listeners: {
          load: function (store, recs) {
            me.piTypes = {};

            Ext.Array.each(recs, function (type) {
              me.piTypes[type.get('Ordinal') + ''] = type.get('TypePath');
            });

            me.onScopeChange(scope);
          },
          scope: me
        }
      });
    },

    onScopeChange: function (scope) {
      var me = this;
      var query;
      var rangeBound = parseInt('' + me.getSetting('rangeBound'), 0);
      var chart;
      var includePartialIterations = !!me.getSetting('includePartialSprints');
      var beginProperty = includePartialIterations ? 'Iteration.EndDate' : 'Iteration.StartDate';
      var endProperty = includePartialIterations ? 'Iteration.StartDate' : 'Iteration.EndDate';

      me.removeAll(true);

      query = Rally.data.QueryFilter.and([{
        property: beginProperty,
        operator: '>=',
        value: me._getStartDate(scope)
      }, {
        property: endProperty,
        operator: '<=',
        value: me._getEndDate(scope)
      }]);

      chart = Ext.create('Rally.ui.chart.Chart', {
        storeType: 'Rally.data.WsapiDataStore',
        storeConfig: me._getStoreConfig(query),

        calculatorType: 'ReleasePlanCalculator',
        calculatorConfig: {
          velocity: me.getSetting('teamVelocity')
        },

        chartConfig: {
          chart: {
            type: 'column'
          },
          title: {
            text: 'Release Plan'
          },
          subtitle: {
            text: scope.getRecord().get('Name')
          },
          xAxis: {
            title: {
              text: 'Iterations'
            }
          },
          yAxis: {
            min: 0,
            title: {
              text: 'Story Points'
            }
          }
        }
      });

      me.add(chart);
    },

    _getStartDate: function (scope) {
      return Rally.util.DateTime.toIsoString(scope.getRecord().get('ReleaseStartDate'));
    },

    _getEndDate: function (scope) {
      return Rally.util.DateTime.toIsoString(scope.getRecord().get('ReleaseDate'));
    },

    _getStoreConfig: function (query) {
      var me = this;
      var stores = [];

      Ext.Array.each(['HierarchicalRequirement', 'Defect'], function (type) {
        stores.push({
          model: type,
          filters: query,
          fetch: ['Name', 'Iteration', 'StartDate', 'EndDate', 'PlanEstimate', 'ScheduleState', 'AcceptedDate']
        });
      });

      stores.push({
        model: me.piTypes['0'],
        filters: me.getContext().getTimeboxScope().getQueryFilter(),
        fetch: ['Name', 'Release', 'ReleaseStartDate', 'ReleaseDate', 'PreliminaryEstimate', 'Value']
      });

      return stores;
    }
});

            
            Rally.launchApp('CustomApp', {
                name:"Release Plan",
                parentRepos:""
            });

        });
    </script>




    <style type="text/css">
.app {
     /* Add app styles here */
}

    </style>

</head>
<body></body>
</html>
